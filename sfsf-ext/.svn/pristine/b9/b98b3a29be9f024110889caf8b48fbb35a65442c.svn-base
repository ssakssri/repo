<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@page import="javax.servlet.http.Cookie" %><%
 
// Fetch unique polling key given by BizX
String pollingKey = request.getParameter("polling_key");
 
// In the example, we distinguish the 3 types of requests from the "action" query string parameter
String action = request.getParameter("action");
 
// Consider additional validation of the polling key
// ex: polling_key_1234567890
if (pollingKey != null) {
    if ("iframe".equals(request.getParameter("action"))) {
        // Did the session existed before the request?
        // The actual method to detect this might vary depending on how SSO is setup and the technology stack
        HttpSession currentSession = request.getSession();
        if (!currentSession.isNew()) {
            // Yes, it did exist, postSuccess to the BizX parent frame
            %>
            <script src="/ui/homepage3/js/framework/BizXIntegrationClient.js"></script>
            <script>BizXIntegrationClient.postSuccess();</script>
            <%
        } else {
            // No, it did not exist
            boolean ALLOW_INSECURE_COOKIES = true; // depends on policy
            if (ALLOW_INSECURE_COOKIES) {
                // Add an insecure cookie using the polling key as a cookie, output scripts to check
                Cookie c = new Cookie("polling_key", pollingKey);
                c.setMaxAge(0);
                response.addCookie(c);
                %>
                <script src="/ui/homepage3/js/framework/BizXIntegrationClient.js"></script>
                <script>BizXIntegrationClient.checkCookie('polling_key');</script>
                <%
            } else {
                // Creating insecure cookies is not allowed
                // However, we can redirect causing the browser to make a second request within the IFRAME
                if (!"true".equals(request.getParameter("flagged"))) {
                    // On the first request, the URL parameter will not be found, create the session and then redirect
                    response.sendRedirect("https://thirdparty.com/smcghee/bizxIntegration.jsp?polling_key="+pollingKey+"&flagged=true");
                } else {
                    // This must be the second request, but the session doesn't exist
                    // Third-party cookies must be disabled, so a popup will be required to fully authenticate
                    %>
                    <script src="/ui/homepage3/js/framework/BizXIntegrationClient.js"></script>
                    <script>BizXIntegrationClient.postPopupRequired();</script>
                    <%
                }
            }
        }
    } else if ("popup".equals(request.getParameter("action"))) {
        // For the popup case, we just postSuccess right away
        %>
        <script src="/ui/homepage3/js/framework/BizXIntegrationClient.js"></script>
        <script>BizXIntegrationClient.postSuccess();</script>
        <%
    }
} else {
    // For the tile to download properly, the CORS response headers must be present
    response.setHeader("Access-Control-Allow-Origin", "https://hcm4preview.sapsf.com");
    response.setHeader("Access-Control-Allow-Credentials", "true");
 
    // Output the JSON that will be used to overwrite properties on the Tile
    response.setHeader("Content-Type", "application/json");
	%>
{
  "tileType": "sap.sf.homepage3.tiles.ArcChartTile",
  "properties": {
    "title": "My Time",
    "subtitle": "연차소진율",
    "arcValue": 90,
    "icon": "sap-icon://learning-assisstant",
    "info": "Due in 3 weeks",
    "subinfo": "Overall Progress"
  }
}
<%}%>
